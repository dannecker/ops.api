language: elixir
cache:
  directories:
    - deps
services:
  - docker
  - postgresql
addons:
  postgresql: "9.5"
elixir:
  - 1.4.2
otp_release:
  - 19.2
env:
  global:
    - MIX_ENV=test
    - DOCKER_HUB_ACCOUNT=nebo15
    - MAIN_BRANCHES="master develop staging" # Branches on which you want version to be incremented
    - RELEASE_BRANCH="master"
    # Docker and GitHub credentials
    - secure: "rqqMHO6niUnJUlrq0UwwDQUKsM0alPgH35uA1kjIbTZlqCUPXnr2hBc8vtgKhOXoJfKvUbSabRE5967q1PyjS07/HJmytoIYaVshFbxWyVuwf3/JtZRNxoEzRsl6JmblcffONzS1eD8HYAu34uavjpTN2w1KKlmvx29DZCj99G4QLA1SIE+lzeXxqbkyK1LHnFBNj4mfyAbGsph3400uW78vyNqNgLgDN8ol0LevR+6SPj49jyZcizIkZslT9sb/AN4FKtosDJI6j13kg6XjyLq702KHeJ7wuYvAMjV66+2HQcOFMGdFW1mfG+6puwjz2fzw2LYF3FrUhGltI9fqDlC8MGamljN+zUpmZXVT7IoSowkFsJKW0FYqWoRd5LkIKMpSy8IwORpUR4Rs06JcL68vSPFxuJFcP7bv4eTn9YOG3LP5gP03MD9L4sSCI9flnSHVePePJKhsrybDtIKR1IxXGaUFXNT4l635U7lzftbVHGcKfnwhLscyQWGiM7hKm18eMdTXtCGY5bsBcDehUJu38gFaRkvsgMujgHKO4bgaJerMzbwngz/qEDS+mEcgY3xybQOHZoUH4BTjbMquSYGTXlXRC+6HZGhrepbYNME1yBrnfPxmZ3pROZl4Jb5zbyY37Xpj6PmxCm4rBTXWhJUvGLoVkUNhrXKR6zlYuYI="
    - secure: "Wqmun05AniB6SurpnO1XQ/EqXBeUtrYyRFwDW9uUUpJrr+R4bDlLvNTRwQ/pdlxHQhmy8DjMRel00LwqDZSZDsnzDs5BS9mcPFTKb0u3vz+ASCapeTpsPoctrzhCdoHu1DEgmu43s+DhUqgqhxZKlh9PnhoFT0wh73uQUii0TKMh1pcmV82TYpOStIQu9eW/vISBAuA77dDCnU3UXI9qV+HCWEhCK9o5mSTGZZIW+yEjXIQ8gR6YmEGb2sfUHd59+8ZcyrIldeYLJN6QqIdBmaegu+jkGBaMnTkPyX5Xug0axPvI0dTEHEZvRJDVRRVG0/izZ69Sld7COFs+ZWS3yvh+KByVonOk5n/ZeeCmvy3Hr59yxXJTrcaw9QnShSWc6Fooef+MaSWYSuQ8ikWYXfjEL45cYv2R8/Uf53iQQDKgHxlPavdSgeu1U3UoLy3IqknIR4fA+TY26vemigVhGicjmMF+qnEvwCJIIYaUXfLBGhLYdN/GvVPiwVeA/3ak3B4AZbB17Yf8Q5HMm2LrCHko6sGW2gF14BGGanasKMWBO/SuhYU5AuBI/2Mvdk22/wd1LcydrhluWfmbV88b0/r2gzdn/KxerUXwPoH0CL1G1aff3GuFdusjRIiiZDEYqNLCmkECSRtmwaIT6aQueqaL5R7aR/kkcrMfwg4Dz4E="
branches:
  # Releases are generated automatically, stop infinite build loop
  except:
    - /[0-9]*\.[0-9]*\.[0-9]*/
before_install:
  # Expose MQ and DB to Docker container
  - sudo ./bin/ci/init-db.sh
script:
  # Increment version in mix.exs
  - ./bin/ci/version-increment.sh
  # Install dependencies
  - mix deps.get
  # Run all tests except pending ones
  - mix test --exclude pending --trace
  # Submit code coverage report to Coveralls
  # Add --pro if you using private repo.
  - mix coveralls.travis --exclude pending
  # Run static code analysis
  - mix credo --strict
  # Check code style
  - mix dogma
  # Build Docker container
  - ./bin/build.sh
  # Initialize DB for Docker container
  - MIX_ENV=dev mix ecto.setup
  # Run Docker container
  - sudo ./bin/start.sh
  - sleep 5
  - docker ps
  - RUNNING_CONTAINERS=`docker ps | wc -l`;
    if [ "${RUNNING_CONTAINERS//[[:space:]]/}" == "1" ]; then
      echo "[E] Container is not started\!";
      docker logs ops --details --since 5h;
      exit 1;
    fi;
  # Run acceptance tests on Docker container
  - "CONTAINER_HTTP_HOST=localhost CONTAINER_HTTP_PORT=4000 mix test test/acceptance"
after_failure:
  - docker logs ops --details --since 5h
after_success:
  # Submit Docker container to Docker Hub and create GitHub Release by pushing tag with changelog
  - ./bin/ci/push.sh
